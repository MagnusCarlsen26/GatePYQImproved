<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATE Practice Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-sidebar: #020617;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #38bdf8;
            --border: #334155;
            --success: #10b981;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        html.light {
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --accent: #0ea5e9;
            --border: #e2e8f0;
            --success: #059669;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05);
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .small {
            font-size: 0.75rem !important;
        }

        .fw-bold {
            font-weight: 700 !important;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 320px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 100;
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 0;
            border-right: none;
        }

        .sidebar-header {
            padding: 30px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
        }

        .sidebar-title {
            font-weight: 800;
            font-size: 1.4rem;
            color: var(--accent);
            letter-spacing: -0.025em;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            scrollbar-width: thin;
        }

        .nav-subject {
            margin-bottom: 10px;
            border-radius: 8px;
            overflow: hidden;
        }

        .subject-header {
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--text-muted);
            padding: 12px 15px;
            letter-spacing: 0.1em;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            transition: background 0.2s;
        }

        .subject-header:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--accent);
        }

        .subject-header .chevron {
            transition: transform 0.3s;
        }

        .nav-subject.collapsed .subject-header .chevron {
            transform: rotate(-90deg);
        }

        .nav-subject.collapsed .exams-container {
            display: none;
        }

        .exam-link {
            display: flex;
            flex-direction: column;
            padding: 10px 15px;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: 0.2s;
            margin-left: 10px;
        }

        /* --- Sidebar Toggle --- */
        .sidebar-toggle-btn {
            position: fixed;
            left: 320px;
            top: 20px;
            z-index: 1000;
            background: var(--bg-sidebar);
            border: 1px solid var(--border);
            color: var(--accent);
            width: 40px;
            height: 40px;
            border-radius: 0 8px 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: none;
        }

        .sidebar.collapsed+.sidebar-toggle-btn {
            left: 0;
        }

        .sidebar-toggle-btn:hover {
            background: var(--bg-card);
        }

        .exam-link:hover {
            background: #1e293b;
            color: var(--accent);
        }

        html.light .exam-link:hover {
            background: #f1f5f9;
        }

        .exam-link.active {
            background: var(--accent);
            color: #020617 !important;
            font-weight: 700;
        }

        .exam-link.active .progress-container {
            background: rgba(0, 0, 0, 0.2) !important;
        }

        .exam-link.active .progress-bar.complete {
            background: #020617 !important;
        }

        /* --- Theme Switcher --- */
        .theme-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: 0.3s;
            box-shadow: var(--shadow);
        }

        .theme-switcher:hover {
            border-color: var(--accent);
        }

        .theme-switcher svg {
            width: 18px;
            height: 18px;
        }

        /* --- Analytics View --- */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--accent);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .notes-summary-card {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid var(--border);
            margin-top: 30px;
        }

        .notes-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .notes-summary-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .notes-summary-item:last-child {
            border-bottom: none;
        }

        .notes-summary-q-info {
            font-size: 0.8rem;
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 5px;
        }

        .notes-summary-text {
            font-size: 0.95rem;
            line-height: 1.6;
            color: var(--text-main);
        }

        .progress-container {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .sidebar .progress-container {
            background: rgba(0, 0, 0, 0.1);
        }

        html.dark .sidebar .progress-container {
            background: rgba(255, 255, 255, 0.05);
        }

        .progress-bar {
            height: 100%;
            transition: width 0.5s ease-out;
        }

        .progress-bar.complete {
            background: var(--success);
        }

        .progress-bar.partial {
            background: #f59e0b;
        }

        .analytics-subject-row {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .analytics-subject-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .analytics-subject-name {
            font-weight: 700;
            color: var(--text-main);
        }

        .analytics-subject-stats {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* --- Sidebar Button overrides --- */
        #analytics-btn {
            background: transparent;
            color: var(--text-main);
            margin-left: 0;
            padding: 12px 15px;
            border-color: var(--border);
        }

        #analytics-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        html.dark #analytics-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        #analytics-btn.active {
            background: var(--accent);
            color: #020617;
            border-color: var(--accent);
        }

        /* --- Main View --- */
        .main-view {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            background: var(--bg-body);
            scroll-behavior: smooth;
        }

        .content-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 60px 20px;
        }

        .page-header {
            margin-bottom: 60px;
        }

        .page-subject {
            color: var(--accent);
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .page-title {
            font-weight: 800;
            font-size: 2.5rem;
            margin: 10px 0 20px;
            letter-spacing: -0.04em;
        }

        /* --- Question Cards --- */
        .q-card {
            background: var(--bg-card);
            border-radius: 20px;
            margin-bottom: 40px;
            border: 1px solid var(--border);
            transition: 0.3s;
            position: relative;
        }

        .q-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        /* Status Colors */
        .q-card.status-complete {
            border-color: var(--success);
        }

        .q-card.status-complete .q-header {
            border-bottom-color: rgba(16, 185, 129, 0.2);
        }

        .q-card.status-partial {
            border-color: #f59e0b;
        }

        .q-card.status-partial .q-header {
            border-bottom-color: rgba(245, 158, 11, 0.2);
        }

        .q-header {
            padding: 25px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .q-id {
            font-family: 'Fira Code', monospace;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .q-body {
            padding: 35px 30px;
            font-size: 1.15rem;
            line-height: 1.8;
            color: var(--text-main);
        }

        .q-body p {
            margin-bottom: 1.5rem;
        }

        .q-footer {
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 0 0 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        html.dark .q-footer {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Status Toggles */
        .status-group {
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.05);
            padding: 5px;
            border-radius: 12px;
        }

        html.dark .status-group {
            background: rgba(0, 0, 0, 0.2);
        }

        .status-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-muted);
            background: transparent;
        }

        .status-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        html.dark .status-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .status-btn.complete.active {
            background: var(--success);
            color: white;
        }

        .status-btn.partial.active {
            background: #f59e0b;
            color: white;
        }

        .status-btn.none.active {
            background: #64748b;
            color: white;
        }

        /* --- Buttons --- */
        .btn-action {
            background: #334155;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: 0.2s;
        }

        .btn-action:hover {
            background: #475569;
        }

        .btn-reveal {
            background: var(--accent);
            color: white;
        }

        .btn-reveal:hover {
            background: #7dd3fc;
        }

        html.light .btn-reveal:hover {
            background: #38bdf8;
        }

        .btn-reveal.active {
            background: #475569;
        }

        .download-btn {
            background: var(--accent);
            color: #020617;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 800;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(56, 189, 248, 0.4);
            filter: brightness(1.1);
        }

        .download-btn svg {
            width: 18px;
            height: 18px;
        }

        .ans-area {
            display: none;
            padding: 25px 30px;
            background: rgba(16, 185, 129, 0.1);
            border-top: 1px solid rgba(16, 185, 129, 0.2);
            border-bottom: 1px solid rgba(16, 185, 129, 0.2);
            color: var(--success);
            font-family: 'Fira Code', monospace;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .notes-area {
            display: none;
            padding: 25px 30px;
            background: rgba(56, 189, 248, 0.05);
            border-top: 1px solid var(--border);
        }

        .ai-area {
            display: none;
            padding: 25px 30px;
            background: rgba(124, 58, 237, 0.05);
            /* Specific purple tint */
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
            font-size: 1rem;
            line-height: 1.7;
        }

        .ai-response-content {
            margin-top: 15px;
        }

        .notes-textarea {
            width: 100%;
            background: var(--bg-body);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-main);
            font-size: 0.95rem;
            min-height: 100px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .notes-save-btn {
            background: var(--accent);
            color: #020617;
            border: none;
            padding: 6px 16px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .notes-save-btn:hover {
            opacity: 0.9;
        }

        .btn-ai {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: white;
        }

        .btn-ai:hover {
            filter: brightness(1.1);
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.3);
        }

        .img-wrapper {
            text-align: center;
            margin: 30px 0;
            background: white;
            padding: 15px;
            border-radius: 12px;
        }

        .img-wrapper img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .q-body img,
        .ans-area img,
        .ai-area img,
        .option-content img,
        .explanation-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
            display: block;
        }

        /* --- Options Styling --- */
        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 40px 0 45px;
        }

        .option-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 18px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .option-label {
            background: var(--accent);
            color: #020617;
            width: 26px;
            height: 26px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.8rem;
            flex-shrink: 0;
            margin-top: 2px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .option-content {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-main);
        }

        @media (max-width: 768px) {
            .options-container {
                grid-template-columns: 1fr;
            }
        }

        .badge-mark {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .type-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-right: 10px;
        }

        .type-mcq {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent);
            border: 1px solid rgba(56, 189, 248, 0.2);
        }

        .type-msq {
            background: rgba(167, 139, 250, 0.1);
            color: #a78bfa;
            border: 1px solid rgba(167, 139, 250, 0.2);
        }

        .type-nat {
            background: rgba(244, 114, 182, 0.1);
            color: #f472b6;
            border: 1px solid rgba(244, 114, 182, 0.2);
        }

        /* --- Star & Tags --- */
        .star-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.2s;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
        }

        .star-btn:hover {
            color: #f59e0b;
        }

        .star-btn.active {
            color: #f59e0b;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            padding: 0 30px 25px;
        }

        .tag-pill {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent);
            padding: 2px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid rgba(56, 189, 248, 0.2);
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.6;
            font-size: 0.9rem;
            line-height: 1;
        }

        .tag-remove:hover {
            opacity: 1;
            color: #f87171;
        }

        .add-tag-btn {
            background: transparent;
            border: 1px dashed var(--border);
            color: var(--text-muted);
            padding: 2px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .add-tag-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .tag-input-container {
            position: relative;
            display: inline-block;
        }

        .tag-input {
            background: var(--bg-body);
            border: 1px solid var(--accent);
            border-radius: 6px;
            padding: 2px 8px;
            font-size: 0.75rem;
            color: var(--text-main);
            outline: none;
            width: 120px;
        }

        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            z-index: 1000;
            max-height: 150px;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .tag-suggestion-item {
            padding: 6px 10px;
            font-size: 0.75rem;
            cursor: pointer;
            color: var(--text-main);
        }

        .tag-suggestion-item:hover {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent);
        }

        .tag-filter-select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-main);
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 0.8rem;
            font-weight: 600;
            outline: none;
            cursor: pointer;
            transition: 0.2s;
            min-width: 140px;
            height: 34px;
            line-height: 1;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: calc(100% - 12px) center;
            padding-right: 32px;
        }

        .tag-filter-select:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .tag-filter-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.1);
        }

        html.dark .tag-filter-select {
            background-color: var(--bg-sidebar);
        }

        .mastery-toggle {
            cursor: pointer;
            color: var(--text-muted);
            transition: 0.2s;
        }

        .mastery-toggle.active {
            color: var(--success);
        }

        .exam-page {
            display: none;
        }

        .exam-page.active {
            display: block;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Search Bar --- */
        .search-container {
            padding: 0 15px 15px;
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-main);
            font-size: 0.85rem;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* --- Filter Bar --- */
        .filter-container {
            display: flex;
            gap: 10px;
            margin-top: 0;
            flex-wrap: wrap;
        }

        .filter-pill {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-pill:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .filter-pill.active {
            background: var(--accent);
            color: #020617;
            border-color: var(--accent);
        }

        .filter-pill.active.status-complete {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .filter-pill.active.status-partial {
            background: #f59e0b;
            border-color: #f59e0b;
            color: white;
        }

        .filter-pill.active.status-none {
            background: #64748b;
            border-color: #64748b;
            color: white;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-sidebar);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-body);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border);
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div>Loading GATE Mastery Portal...</div>
    </div>

    <div class="sidebar" id="sidebar">
        <!-- <div class="sidebar-header">
            <div>
                <div class="sidebar-title">GATE MASTERY</div>
                <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;">STUDY & PRACTICE PORTAL
                </div>
            </div>
        </div> -->
        <div class="search-container">
            <input type="text" id="subject-search" class="search-input" placeholder="Search subjects or exams...">
        </div>
        <div style="padding: 0 15px 15px;">
            <button onclick="showAnalytics()" class="exam-link" id="analytics-btn"
                style="width: 100%; text-align: left; display: flex; align-items: center; gap: 10px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path
                        d="M4 11H2v3h2v-3zm5-4H7v7h2V7zm5-5v12h-2V2h2zm-2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1h-2zM6 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm-5 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3z" />
                </svg>
                ANALYTICS DASHBOARD
            </button>
        </div>
        <div class="sidebar-content" id="sidebar-nav">
            <!-- Sidebar content will be injected here -->
        </div>
    </div>
    <button class="sidebar-toggle-btn" onclick="toggleSidebar()" id="sidebar-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z" />
        </svg>
    </button>

    <button class="theme-switcher" onclick="toggleTheme()" id="theme-toggle">
        <span id="theme-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
            </svg>
        </span>
        <span id="theme-text"></span>
    </button>

    <div class="main-view">
        <div class="content-container" id="main-content">
            <!-- Questions will be injected here -->
        </div>
    </div>

    <script>
        // Initialize Theme immediately to avoid flickering
        (function () {
            const savedTheme = localStorage.getItem('gateTheme') || 'dark';
            document.documentElement.classList.remove('dark', 'light');
            document.documentElement.classList.add(savedTheme);
        })();

        let portalData = null;
        let activeExamId = null;
        let collapsedSubjects = new Set();
        let currentFilter = 'all'; // 'all', 'starred', 'complete', 'partial', 'none'
        let currentTagFilter = 'all';
        let currentSectionFilter = 'all';
        let currentSortOrder = 'desc'; // 'asc' or 'desc'

        function abbreviate(text, type) {
            if (type === 'subject') {
                const mapping = {
                    "Compiler Design": "CD",
                    "Computer Networks": "CN",
                    "Databases & DBMS": "DBMS",
                    "Operating Systems": "OS",
                    "Programming & DS": "PDS",
                    "Theory of Computation": "TOC",
                    "Digital Logic": "DL",
                    "Engineering Mathematics": "EM",
                    "Discrete Mathematics": "DM",
                    "General Aptitude": "GA",
                    "Mixed Subjects": "Mixed"
                };
                return mapping[text] || text;
            } else if (type === 'test') {
                let clean = text.includes('|') ? text.split('|')[1].trim() : text;
                return clean
                    .replace(/Topic Wise Test/gi, 'TWT')
                    .replace(/Subject Wise Test/gi, 'SWT')
                    .replace(/Full Length Test/gi, 'FLT')
                    .replace(/Practice Test/gi, 'PT');
            }
            return text;
        }

        function slugify(text) {
            return text.toString()
                .toLowerCase()
                .replace(/[|\/\s]+/g, '-')
                .replace(/[^\w\-]+/g, '')
                .replace(/\-\-+/g, '-')
                .replace(/^-+/, '')
                .replace(/-+$/, '');
        }

        function getQuestionType(q) {
            const ans = q.answer.toString().trim().toLowerCase();
            const hasOptions = q.options && Object.keys(q.options).length > 0;

            if (ans.includes(';') || (hasOptions && ans.length > 1 && /^[a-d,; ]+$/.test(ans))) {
                return { label: 'MSQ', class: 'type-msq' };
            }
            if (hasOptions || /^[a-d]$/.test(ans)) {
                return { label: 'MCQ', class: 'type-mcq' };
            }
            return { label: 'NAT', class: 'type-nat' };
        }

        function localizeImageUrls(text) {
            if (!text) return text;
            // Replace Mathpix URLs
            let localizedText = text.replace(/https:\/\/cdn\.mathpix\.com\/snip\/images\/([a-zA-Z0-9_-]+\.original\.fullsize\.png)/g, 'images/$1');
            // Replace GateOverflow URLs (handling both & and &amp;)
            localizedText = localizedText.replace(/https:\/\/gateoverflow\.in\/\?qa=blob(?:\&amp;|\&)qa_blobid=(\d+)/g, 'images/gateoverflow_blob_$1.png');
            // Replace Google User Content URLs
            localizedText = localizedText.replace(/https:\/\/lh\d+\.googleusercontent\.com\/([a-zA-Z0-9_-]+)/g, 'images/google_image_$1.png');
            return localizedText;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');
            const newTheme = isDark ? 'light' : 'dark';

            html.classList.remove('dark', 'light');
            html.classList.add(newTheme);

            updateThemeUI(newTheme);
            localStorage.setItem('gateTheme', newTheme);
        }

        function updateThemeUI(theme) {
            const text = document.getElementById('theme-text');
            const icon = document.getElementById('theme-icon');

            if (theme === 'light') {
                icon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                    </svg>
                `;
            } else {
                icon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                    </svg>
                `;
            }
        }

        function toggleSubject(subject) {
            const subjectDiv = document.querySelector(`[data-subject="${CSS.escape(subject)}"]`);
            if (subjectDiv) {
                subjectDiv.classList.toggle('collapsed');
                if (subjectDiv.classList.contains('collapsed')) {
                    collapsedSubjects.add(subject);
                } else {
                    collapsedSubjects.delete(subject);
                }
            }
        }

        async function initPortal() {
            try {
                // Ensure MathJax is ready
                if (window.MathJax && window.MathJax.startup && window.MathJax.startup.promise) {
                    await window.MathJax.startup.promise;
                }

                // Initialize UI based on theme
                const currentTheme = document.documentElement.classList.contains('light') ? 'light' : 'dark';
                updateThemeUI(currentTheme);

                const response = await fetch('../extraction/questions.json?v=' + new Date().getTime());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                portalData = await response.json();

                // Collapse all subjects by default
                const sortedSubjects = Object.keys(portalData).sort();
                sortedSubjects.forEach(s => collapsedSubjects.add(s));

                renderSidebar();

                // Auto-select last exam or first exam
                const lastExamId = localStorage.getItem('gateLastExam');
                const firstSubject = Object.keys(portalData).sort()[0];
                const firstExamId = (firstSubject && portalData[firstSubject].length > 0) ? portalData[firstSubject][0].id : null;

                if (lastExamId) {
                    // Fix: Pass 'all' as sectionName
                    await switchExam(lastExamId, 'all', true);

                    // Also ensure the subject is expanded for the last exam
                    for (const s in portalData) {
                        if (portalData[s].find(e => e.id === lastExamId)) {
                            collapsedSubjects.delete(s);
                            renderSidebar();
                            break;
                        }
                    }
                } else if (firstExamId) {
                    // Fix: Pass 'all' as sectionName
                    await switchExam(firstExamId, 'all', true);
                    // Expand the first subject if it's the first time
                    if (firstSubject) {
                        collapsedSubjects.delete(firstSubject);
                        renderSidebar();
                    }
                }

                // Restore scroll position
                const savedScroll = localStorage.getItem('gateScrollPos');
                if (savedScroll) {
                    setTimeout(() => {
                        document.querySelector('.main-view').scrollTop = parseInt(savedScroll);
                    }, 100);
                }

                document.getElementById('loading-overlay').style.display = 'none';
            } catch (error) {
                console.error('Error loading portal data:', error);
                const overlay = document.getElementById('loading-overlay');
                overlay.innerHTML = `
                    <div style="text-align: center; color: #f87171; padding: 20px;">
                        <h4 style="margin-bottom: 15px;">Error Loading Data</h4>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">
                            This usually happens if you open <code>index.html</code> directly from your file explorer.<br><br>
                            <strong>To fix this, run a local server:</strong><br><br>
                            <code style="background: #000; padding: 10px; border-radius: 5px; display: block; margin: 10px 0;">cd web && python -m http.server 8000</code><br>
                            Then visit <a href="http://localhost:8000" style="color: var(--accent);">http://localhost:8000</a> in your browser.
                        </p>
                    </div>
                `;
            }
        }

        function renderSidebar(filter = '') {
            const nav = document.getElementById('sidebar-nav');
            nav.innerHTML = '';

            const masteryData = JSON.parse(localStorage.getItem('gateMastery') || '{}');
            const normalizedMastery = Array.isArray(masteryData)
                ? masteryData.reduce((acc, id) => ({ ...acc, [id]: 'complete' }), {})
                : masteryData;

            const sortedSubjects = Object.keys(portalData).sort();

            sortedSubjects.forEach(subject => {
                const exams = portalData[subject];
                const filteredExams = exams.filter(e =>
                    subject.toLowerCase().includes(filter.toLowerCase()) ||
                    e.display_name.toLowerCase().includes(filter.toLowerCase())
                );

                if (filteredExams.length === 0) return;

                // Calculate subject progress
                let totalQs = 0;
                let completedQs = 0;
                exams.forEach(exam => {
                    exam.sections.forEach(section => {
                        section.questions.forEach(q => {
                            totalQs++;
                            if (normalizedMastery[q.post_id] === 'complete') {
                                completedQs++;
                            }
                        });
                    });
                });
                const progress = totalQs > 0 ? (completedQs / totalQs) * 100 : 0;

                const isSearching = filter.length > 0;
                const isCollapsed = collapsedSubjects.has(subject) && !isSearching;

                const subjectDiv = document.createElement('div');
                subjectDiv.className = `nav-subject ${isCollapsed ? 'collapsed' : ''}`;
                subjectDiv.setAttribute('data-subject', subject);

                const header = document.createElement('div');
                header.className = 'subject-header';
                header.onclick = () => toggleSubject(subject);
                header.innerHTML = `
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <span>${subject}</span>
                            <span style="font-size: 0.65rem; opacity: 0.7;">${Math.round(progress)}%</span>
                        </div>
                        <div class="progress-container" style="height: 3px; margin-top: 2px;">
                            <div class="progress-bar complete" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    <svg class="chevron" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="margin-left: 10px;">
                        <path d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                    </svg>
                `;
                subjectDiv.appendChild(header);

                const examsContainer = document.createElement('div');
                examsContainer.className = 'exams-container';

                filteredExams.forEach(exam => {
                    const subAbbr = abbreviate(subject, 'subject');
                    const testShort = abbreviate(exam.display_name, 'test'); // e.g. "TWT 2"
                    const formattedTest = testShort.replace(/(\D+)(\d+)/, '$1 - $2').trim();

                    // Calculate exam progress
                    let examTotalQs = 0;
                    let examCompletedQs = 0;
                    exam.sections.forEach(section => {
                        section.questions.forEach(q => {
                            examTotalQs++;
                            if (normalizedMastery[q.post_id] === 'complete') {
                                examCompletedQs++;
                            }
                        });
                    });
                    const examProgress = examTotalQs > 0 ? (examCompletedQs / examTotalQs) * 100 : 0;

                    // Add "All Questions" link
                    const allLink = document.createElement('a');
                    allLink.id = `link-${exam.id}-all`;
                    allLink.href = 'javascript:void(0)';
                    allLink.className = `exam-link ${activeExamId === exam.id && currentSectionFilter === 'all' ? 'active' : ''}`;
                    allLink.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 4px;">
                            <span>All Questions <span style="font-size: 0.75rem; opacity: 0.7;">(${examTotalQs})</span></span>
                            <span style="font-size: 0.6rem; opacity: 0.6;">${Math.round(examProgress)}%</span>
                        </div>
                        <div class="progress-container" style="height: 2px; margin-top: 0; width: 100%;">
                            <div class="progress-bar complete" style="width: ${examProgress}%"></div>
                        </div>
                    `;
                    allLink.onclick = (e) => {
                        e.stopPropagation();
                        switchExam(exam.id, 'all');
                    };
                    examsContainer.appendChild(allLink);

                    // Render Section Links (Sorted by count descending)
                    const sortedSections = [...exam.sections].sort((a, b) => b.questions.length - a.questions.length);

                    sortedSections.forEach(section => {
                        // Calculate section progress
                        let secTotal = section.questions.length;
                        let secCompleted = 0;
                        section.questions.forEach(q => {
                            if (normalizedMastery[q.post_id] === 'complete') {
                                secCompleted++;
                            }
                        });
                        const secProgress = secTotal > 0 ? (secCompleted / secTotal) * 100 : 0;

                        // Format name: replace hyphens with spaces and capitalize
                        const formatName = section.name.replace(/-/g, ' ')
                            .replace(/\b\w/g, l => l.toUpperCase());

                        const secLink = document.createElement('a');
                        secLink.id = `link-${exam.id}-${section.name.replace(/\s+/g, '_')}`;
                        secLink.href = 'javascript:void(0)';
                        secLink.className = `exam-link ${activeExamId === exam.id && currentSectionFilter === section.name ? 'active' : ''}`;
                        // Indent section links slightly
                        secLink.style.paddingLeft = "25px";
                        secLink.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <span style="font-size: 0.85rem;">${formatName} <span style="font-size: 0.75rem; opacity: 0.7;">(${secTotal})</span></span>
                                <span style="font-size: 0.6rem; opacity: 0.6;">${Math.round(secProgress)}%</span>
                            </div>
                        `;
                        secLink.onclick = (e) => {
                            e.stopPropagation();
                            switchExam(exam.id, section.name);
                        };
                        examsContainer.appendChild(secLink);
                    });
                });

                subjectDiv.appendChild(examsContainer);
                nav.appendChild(subjectDiv);
            });
        }

        function switchExam(eid, sectionName = 'all', isInitial = false) {
            activeExamId = eid;
            currentFilter = 'all'; // Reset filter when switching exams
            currentTagFilter = 'all'; // Reset tag filter
            currentSectionFilter = sectionName; // Set section filter
            localStorage.setItem('gateLastExam', eid);

            if (!isInitial) {
                localStorage.setItem('gateScrollPos', 0);
                document.querySelector('.main-view').scrollTop = 0;
            }

            // Update sidebar links
            document.querySelectorAll('.exam-link').forEach(l => l.classList.remove('active'));
            document.getElementById('analytics-btn').classList.remove('active');

            // Activate the correct link (All or specific section)
            let activeLinkId = `link-${eid}-${sectionName === 'all' ? 'all' : sectionName.replace(/\s+/g, '_')}`;
            const activeLink = document.getElementById(activeLinkId);
            if (activeLink) activeLink.classList.add('active');

            // Find exam data
            let subjectName = '';
            let examData = null;

            for (const s in portalData) {
                const found = portalData[s].find(e => e.id === eid);
                if (found) {
                    subjectName = s;
                    examData = found;
                    break;
                }
            }

            if (!examData) return;

            // Get all tags and counts for this exam
            const tagsData = JSON.parse(localStorage.getItem('gateTags') || '{}');
            const starsData = JSON.parse(localStorage.getItem('gateStars') || '{}');
            const tagCounts = {};
            let starredCount = 0;

            examData.sections.forEach(section => {
                section.questions.forEach(q => {
                    const qid = q.post_id;
                    const qTags = tagsData[qid] || [];
                    qTags.forEach(t => {
                        tagCounts[t] = (tagCounts[t] || 0) + 1;
                    });
                    if (starsData[qid]) starredCount++;
                });
            });
            const sortedTags = Object.keys(tagCounts).sort();

            const main = document.getElementById('main-content');

            // Determine dynamic title
            let displayTitle = subjectName;
            let displaySubtitle = 'All Questions';

            if (currentSectionFilter !== 'all') {
                displayTitle = currentSectionFilter.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                displaySubtitle = subjectName;
            }

            main.innerHTML = `
                <div class="page-header">
                    <div class="page-subject">${displaySubtitle}</div>
                    <div class="page-title">${displayTitle}</div>
                    <div class="d-flex flex-wrap gap-4 align-items-center mb-3">
                        <div class="small fw-bold" style="color: var(--text-muted); letter-spacing: 0.05em; text-transform: uppercase;">
                            COUNT: <span id="header-count" style="color: var(--text-main); text-transform: none; letter-spacing: normal;">${examData.total_qs} QUESTIONS</span>
                        </div>
                        <div class="small fw-bold" style="color: var(--text-muted); letter-spacing: 0.05em; text-transform: uppercase;">
                            WEIGHT: <span id="header-weight" style="color: var(--text-main); text-transform: none; letter-spacing: normal;">${examData.total_marks} MARKS</span>
                        </div>
                        ${examData.test_link ? `
                            <a href="${examData.test_link}" target="_blank" class="btn-action btn-reveal" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px; padding: 6px 16px; margin-left: auto;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0zM4.5 7.5a.5.5 0 0 0 0 1h5.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 1 0-.708.708L10.293 7.5H4.5z"/></svg>
                                TAKE TEST ON GO
                            </a>
                        ` : ''}
                    </div>
                    ${examData.syllabus ? `
                        <div class="syllabus-info mb-4" style="background: rgba(56, 189, 248, 0.05); border: 1px solid var(--border); border-radius: 12px; padding: 15px;">
                            <div class="small fw-bold mb-1" style="color: var(--text-muted); letter-spacing: 0.05em; text-transform: uppercase;">Syllabus:</div>
                            <div style="color: var(--text-main); font-size: 0.95rem; line-height: 1.5;">${examData.syllabus}</div>
                        </div>
                    ` : ''}
                    
                    <div class="d-flex flex-wrap align-items-center gap-3 mt-4">
                        <div class="filter-container">
                            <div class="filter-pill ${currentFilter === 'all' ? 'active' : ''}" onclick="setFilter('all')" id="filter-all">
                                <span class="filter-label">ALL (0)</span>
                            </div>
                            <div class="filter-pill status-complete ${currentFilter === 'complete' ? 'active' : ''}" onclick="setFilter('complete')" id="filter-complete">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>
                                <span class="filter-label">UNDERSTOOD (0)</span>
                            </div>
                            <div class="filter-pill status-partial ${currentFilter === 'partial' ? 'active' : ''}" onclick="setFilter('partial')" id="filter-partial">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/></svg>
                                <span class="filter-label">PARTIAL (0)</span>
                            </div>
                            <div class="filter-pill status-none ${currentFilter === 'none' ? 'active' : ''}" onclick="setFilter('none')" id="filter-none">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                                <span class="filter-label">NOT UNDERSTOOD (0)</span>
                            </div>
                        </div>


                        <select id="tag-filter-dropdown" class="tag-filter-select" onchange="setTagFilter(this.value)">
                            <option value="all"> All Tags</option>
                        </select>
                        <select id="sort-order-dropdown" class="tag-filter-select" onchange="setSortOrder(this.value)">
                            <option value="desc"> Newest First</option>
                            <option value="asc"> Oldest First</option>
                        </select>
                    </div>
                </div>
                <div id="questions-list"></div>
            `;

            updateTagDropdown();
            updateFilterCounts();
            renderQuestions();
        }

        function updateFilterCounts() {
            let examData = null;
            for (const s in portalData) {
                const found = portalData[s].find(e => e.id === activeExamId);
                if (found) {
                    examData = found;
                    break;
                }
            }
            if (!examData) return;

            const masteryData = JSON.parse(localStorage.getItem('gateMastery') || '{}');
            const starsData = JSON.parse(localStorage.getItem('gateStars') || '{}');
            const tagsData = JSON.parse(localStorage.getItem('gateTags') || '{}');
            const normalizedMastery = Array.isArray(masteryData)
                ? masteryData.reduce((acc, id) => ({ ...acc, [id]: 'complete' }), {})
                : masteryData;

            let counts = { all: 0, complete: 0, partial: 0, none: 0, starred: 0 };

            const sectionsToShow = currentSectionFilter === 'all'
                ? examData.sections
                : examData.sections.filter(s => s.name === currentSectionFilter);

            sectionsToShow.forEach(section => {
                section.questions.forEach(q => {
                    const qid = q.post_id;
                    const isStarred = starsData[qid];
                    const qTags = tagsData[qid] || [];

                    // Filter by tag for pill counts
                    let matchesTag = true;
                    if (currentTagFilter === 'starred') {
                        matchesTag = isStarred;
                    } else if (currentTagFilter !== 'all') {
                        matchesTag = qTags.includes(currentTagFilter);
                    }

                    if (matchesTag) {
                        counts.all++;
                        const status = normalizedMastery[qid] || 'none';
                        counts[status]++;
                        if (isStarred) counts.starred++;
                    }
                });
            });

            document.getElementById('filter-all').querySelector('.filter-label').textContent = `ALL (${counts.all})`;
            document.getElementById('filter-complete').querySelector('.filter-label').textContent = `UNDERSTOOD (${counts.complete})`;
            document.getElementById('filter-partial').querySelector('.filter-label').textContent = `PARTIAL (${counts.partial})`;
            document.getElementById('filter-none').querySelector('.filter-label').textContent = `NOT UNDERSTOOD (${counts.none})`;
        }

        function setFilter(filter) {
            currentFilter = filter;

            // Update UI
            const pills = document.querySelectorAll('.filter-pill');
            if (pills.length >= 4) {
                pills[0].classList.toggle('active', filter === 'all');
                pills[1].classList.toggle('active', filter === 'complete');
                pills[2].classList.toggle('active', filter === 'partial');
                pills[3].classList.toggle('active', filter === 'none');
            }

            renderQuestions();
        }

        function setTagFilter(tag) {
            currentTagFilter = tag;
            renderQuestions();
        }

        function setSectionFilter(section) {
            currentSectionFilter = section;
            renderQuestions();
        }

        function setSortOrder(order) {
            currentSortOrder = order;
            renderQuestions();
        }

        function renderQuestions() {
            const qList = document.getElementById('questions-list');
            if (!qList) return;

            qList.innerHTML = '';

            // Find exam data
            let examData = null;
            for (const s in portalData) {
                const found = portalData[s].find(e => e.id === activeExamId);
                if (found) {
                    examData = found;
                    break;
                }
            }

            if (!examData) return;

            const masteryData = JSON.parse(localStorage.getItem('gateMastery') || '{}');
            const notesData = JSON.parse(localStorage.getItem('gateNotes') || '{}');
            const starsData = JSON.parse(localStorage.getItem('gateStars') || '{}');
            const tagsData = JSON.parse(localStorage.getItem('gateTags') || '{}');
            const normalizedMastery = Array.isArray(masteryData)
                ? masteryData.reduce((acc, id) => ({ ...acc, [id]: 'complete' }), {})
                : masteryData;

            let visibleCount = 0;
            let visibleWeight = 0;

            // Filter sections based on section filter
            const sectionsToShow = currentSectionFilter === 'all'
                ? examData.sections
                : examData.sections.filter(s => s.name === currentSectionFilter);

            sectionsToShow.forEach(section => {
                let filteredQuestions = section.questions.filter(q => {
                    const qid = q.post_id;
                    const status = normalizedMastery[qid] || 'none';
                    const isStarred = starsData[qid];
                    const qTags = tagsData[qid] || [];

                    // Filter by mastery status
                    let matchesStatus = true;
                    if (currentFilter !== 'all') {
                        matchesStatus = (status === currentFilter);
                    }

                    // Filter by tag or star
                    let matchesTag = true;
                    if (currentTagFilter === 'starred') {
                        matchesTag = isStarred;
                    } else if (currentTagFilter !== 'all') {
                        matchesTag = qTags.includes(currentTagFilter);
                    }

                    return matchesStatus && matchesTag;
                });

                // Sort by year
                filteredQuestions.sort((a, b) => {
                    const yearA = parseInt(a.year) || 0;
                    const yearB = parseInt(b.year) || 0;
                    return currentSortOrder === 'desc' ? yearB - yearA : yearA - yearB;
                });

                if (filteredQuestions.length > 0) {
                    // Only show section header if viewing all sections
                    if (currentSectionFilter === 'all' && section.name !== "Technical") {
                        const h4 = document.createElement('h4');
                        h4.style = "margin: 40px 0 20px; color: var(--accent); font-weight: 800; font-size: 0.9rem; text-transform: uppercase;";
                        h4.innerText = `${section.name} (${filteredQuestions.length})`;
                        qList.appendChild(h4);
                    }

                    filteredQuestions.forEach(q => {
                        visibleCount++;
                        visibleWeight += parseFloat(q.award || 0);
                        const qid = q.post_id;
                        const status = normalizedMastery[qid] || 'none';
                        const note = notesData[qid] || '';
                        const isStarred = starsData[qid] || false;
                        const tags = tagsData[qid] || [];
                        const qType = getQuestionType(q);

                        // Render Options if they exist
                        let optionsHtml = '';
                        if (q.options && Object.keys(q.options).length > 0) {
                            optionsHtml = `
                                <div class="options-container mt-4">
                                    ${Object.entries(q.options).map(([label, text]) => `
                                        <div class="option-item">
                                            <span class="option-label">${label}</span>
                                            <div class="option-content">${localizeImageUrls(text)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }

                        const qCard = document.createElement('div');
                        qCard.className = `q-card status-${status}`;
                        qCard.id = `q-card-${q.post_id}`;
                        qCard.innerHTML = `
                            <div class="q-header">
                                <div class="d-flex align-items-center">
                                    <span class="type-badge ${qType.class}">${qType.label}</span>
                                    <div class="q-id">QUESTION #${q.local_idx}</div>
                                    <button class="star-btn ${isStarred ? 'active' : ''}" onclick="toggleStar('${q.post_id}')" title="Star this question">
                                        ${isStarred
                                ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>'
                                : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957-2.851-2.712 3.965-.563L8 3.483l1.721 3.424 3.965.563-2.85 2.712.693 3.957-3.685-1.894z"/></svg>'}
                                    </button>
                                    ${q.year ? `<span class="year-badge" style="background: rgba(59, 130, 246, 0.15); color: #60a5fa; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; margin-left: 8px;">${q.year}</span>` : ''}
                                </div>
                                <div class="d-flex gap-2">
                                    <div class="badge-mark">+${q.award}M</div>
                                    <div class="badge-mark" style="color: #f87171; background: rgba(248, 113, 113, 0.1);">-${q.penalty}</div>
                                </div>
                            </div>
                            <div class="q-body">${localizeImageUrls(q.text)}</div>
                            ${optionsHtml}
                            <div class="ans-area" id="ans-${q.post_id}">
                                <div style="font-size: 0.7rem; color: var(--success); opacity: 0.8; margin-bottom: 5px;">CORRECT SOLUTION:</div>
                                <div class="mb-3">${localizeImageUrls(q.answer)}</div>
                                ${q.solution ? `
                                    <div style="font-size: 0.7rem; color: var(--accent); opacity: 0.8; margin-top: 15px; margin-bottom: 5px; border-top: 1px solid rgba(168, 85, 247, 0.2); padding-top: 10px;">EXPLANATION:</div>
                                    <div class="explanation-content">${localizeImageUrls(q.solution)}</div>
                                ` : ''}
                            </div>
                            <div class="notes-area" id="notes-area-${q.post_id}">
                                <div style="font-size: 0.7rem; color: var(--accent); opacity: 0.8; margin-bottom: 10px;">YOUR NOTES:</div>
                                <textarea class="notes-textarea" id="notes-text-${q.post_id}" placeholder="Type your notes here...">${note}</textarea>
                                <button class="notes-save-btn" onclick="saveNote('${q.post_id}')">SAVE NOTES</button>
                                <span id="save-status-${q.post_id}" style="font-size: 0.75rem; color: var(--success); margin-left: 10px; display: none;">Saved!</span>
                            </div>
                            <div class="ai-area" id="ai-area-${q.post_id}">
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.75rem; color: #a855f7; font-weight: 700; margin-bottom: 5px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.58 26.58 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.933.933 0 0 1-.765.935c-.845.147-2.34.346-4.235.346-1.895 0-3.39-.2-4.235-.346A.933.933 0 0 1 3 9.219V8.062Zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a24.767 24.767 0 0 1-1.871-.183.25.25 0 0 0-.068.495c.55.076 1.232.149 2.02.193a.25.25 0 0 0 .189-.071l.754-.736.847 1.71a.25.25 0 0 0 .404.062l.932-.97a25.286 25.286 0 0 0 1.922-.188.25.25 0 0 0-.068-.495c-.538.074-1.207.145-1.98.189a.25.25 0 0 0-.166.076l-.754.785-.958-1.935a.25.25 0 0 0-.165-.138ZM3.56 8.218v.743c5.467-.43 3.535 0 8.88 0v-.743c-3.129 1.901-5.751 1.901-8.88 0Z"/>
                                    </svg>
                                    AI SOLUTION (GEMINI 3 FLASH PREVIEW)
                                </div>
                                <div class="ai-response-content" id="ai-content-${q.post_id}"></div>
                            </div>
                            <div class="tags-container" id="tags-container-${q.post_id}">
                                ${tags.map(t => `
                                    <div class="tag-pill">
                                        ${t}
                                        <span class="tag-remove" onclick="removeTag('${q.post_id}', '${t}')">&times;</span>
                                    </div>
                                `).join('')}
                                <button class="add-tag-btn" onclick="showAddTag('${q.post_id}')">+ Tag</button>
                            </div>
                            <div class="q-footer">
                                <div class="d-flex gap-2">
                                    <button class="btn-action btn-reveal" id="btn-ans-${q.post_id}" onclick="toggleAns('${q.post_id}')">REVEAL SOLUTION</button>
                                    <button class="btn-action btn-ai" id="btn-ai-${q.post_id}" onclick="askAI('${q.post_id}')">ASK AI</button>
                                    <button class="btn-action" id="btn-notes-${q.post_id}" onclick="toggleNotes('${q.post_id}')" style="background: #334155;">NOTES</button>
                                    <button class="btn-action" onclick="window.open('https://gateoverflow.in/${q.post_id}/${slugify(examData.display_name)}-question-${q.local_idx}', '_blank')" style="background: #059669;">GO SOLUTION</button>
                                </div>
                                <div class="status-group">
                                    <button class="status-btn none ${status === 'none' ? 'active' : ''}" 
                                            onclick="setQuestionStatus('${q.post_id}', 'none')" title="Not Understood">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                                    </button>
                                    <button class="status-btn partial ${status === 'partial' ? 'active' : ''}" 
                                            onclick="setQuestionStatus('${q.post_id}', 'partial')" title="Partially Understood">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/></svg>
                                    </button>
                                    <button class="status-btn complete ${status === 'complete' ? 'active' : ''}" 
                                            onclick="setQuestionStatus('${q.post_id}', 'complete')" title="Completely Understood">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>
                                    </button>
                                </div>
                            </div>
                        `;
                        qList.appendChild(qCard);
                    });
                }
            });

            if (visibleCount === 0) {
                qList.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-muted); opacity: 0.7;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-filter" viewBox="0 0 16 16" style="opacity: 0.2; margin-bottom: 20px;">
                            <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/>
                        </svg>
                        <h4>No questions match this filter</h4>
                        <p>Try selecting a different filter or "Show All".</p>
                    </div>
                `;
            }

            // Update Header Counts
            const hCount = document.getElementById('header-count');
            const hWeight = document.getElementById('header-weight');
            if (hCount) hCount.textContent = `${visibleCount} QUESTIONS`;
            if (hWeight) hWeight.textContent = `${visibleWeight} MARKS`;

            // Re-render MathJax
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise();
            }
        }

        function exportData() {
            const backup = {};
            const prefix = 'gate';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix)) {
                    try {
                        backup[key] = JSON.parse(localStorage.getItem(key));
                    } catch (e) {
                        backup[key] = localStorage.getItem(key);
                    }
                }
            }
            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `gate_portal_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function showAnalytics() {
            activeExamId = null;
            document.querySelectorAll('.exam-link').forEach(l => l.classList.remove('active'));
            document.getElementById('analytics-btn').classList.add('active');

            const masteryData = JSON.parse(localStorage.getItem('gateMastery') || '{}');
            const notesData = JSON.parse(localStorage.getItem('gateNotes') || '{}');
            const starsData = JSON.parse(localStorage.getItem('gateStars') || '{}');
            const normalizedMastery = Array.isArray(masteryData)
                ? masteryData.reduce((acc, id) => ({ ...acc, [id]: 'complete' }), {})
                : masteryData;

            let totalQs = 0;
            let completeCount = 0;
            let partialCount = 0;
            let starredCount = 0;
            let subjectStats = {};
            let allNotes = [];

            for (const subject in portalData) {
                subjectStats[subject] = { total: 0, complete: 0, partial: 0, starred: 0 };
                portalData[subject].forEach(exam => {
                    exam.sections.forEach(section => {
                        section.questions.forEach(q => {
                            totalQs++;
                            subjectStats[subject].total++;
                            const qid = q.post_id;
                            const status = normalizedMastery[qid];
                            if (status === 'complete') {
                                completeCount++;
                                subjectStats[subject].complete++;
                            } else if (status === 'partial') {
                                partialCount++;
                                subjectStats[subject].partial++;
                            }

                            if (starsData[qid]) {
                                starredCount++;
                                subjectStats[subject].starred++;
                            }

                            if (notesData[qid]) {
                                allNotes.push({
                                    subject: subject,
                                    exam: exam.display_name,
                                    qNum: q.local_idx,
                                    text: notesData[qid],
                                    postId: q.post_id,
                                    examId: exam.id
                                });
                            }
                        });
                    });
                });
            }

            const main = document.getElementById('main-content');
            main.innerHTML = `
                < div class="page-header d-flex justify-content-between align-items-center flex-wrap gap-3" >
                    <div>
                        <div class="page-subject">Performance Overview</div>
                        <div class="page-title" style="margin-bottom: 0;">Learning Analytics</div>
                    </div>
                    <button class="download-btn" onclick="exportData()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                        </svg>
                        DOWNLOAD MY DATA
                    </button>
                </div >

                <div class="analytics-grid">
                    <div class="stat-card" style="grid-column: 1 / -1; display: flex; flex-direction: row; align-items: center; justify-content: space-between; gap: 20px;">
                        <div>
                           <div class="stat-label" style="font-size: 0.9rem; font-weight: 700; color: var(--accent);">Gemini AI Settings</div>
                           <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">Configure your API Key to enable AI features.</div>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                             <input type="password" id="gemini-api-input" placeholder="Paste API Key Here" 
                                    style="background: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); padding: 8px 12px; border-radius: 6px; width: 250px; font-size: 0.85rem;"
                                    value="${localStorage.getItem('gateGeminiKey') || ''}">
                             <button class="btn-action" onclick="saveGeminiKey()" style="padding: 8px 16px; background: var(--success); font-size: 0.85rem;">SAVE</button>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-label">Total Questions</div>
                        <div class="stat-value">${totalQs}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Starred Items</div>
                        <div class="stat-value" style="color: #f59e0b">${starredCount}</div>
                        <div class="analytics-subject-stats">Important for Review</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Completely Understood</div>
                        <div class="stat-value" style="color: var(--success)">${completeCount}</div>
                        <div class="analytics-subject-stats">${((completeCount / totalQs) * 100).toFixed(1)}% Completion</div>
                        <div class="progress-container">
                            <div class="progress-bar complete" style="width: ${(completeCount / totalQs) * 100}%"></div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Partially Understood</div>
                        <div class="stat-value" style="color: #f59e0b">${partialCount}</div>
                        <div class="analytics-subject-stats">${((partialCount / totalQs) * 100).toFixed(1)}% Coverage</div>
                        <div class="progress-container">
                            <div class="progress-bar partial" style="width: ${(partialCount / totalQs) * 100}%"></div>
                        </div>
                    </div>
                </div>

                <div class="notes-summary-card">
                    <div class="notes-summary-header">
                        <h3 style="margin: 0; font-weight: 800; letter-spacing: -0.02em;">My Study Notes (${allNotes.length})</h3>
                    </div>
                    <div id="notes-summary-list">
                        ${allNotes.length === 0 ?
                    '<div style="color: var(--text-muted); padding: 20px; text-align: center;">No notes saved yet. Add notes to questions to see them here.</div>' :
                    allNotes.map(n => `
                                <div class="notes-summary-item">
                                    <div class="notes-summary-q-info">
                                        ${n.subject} &middot; ${n.exam} &middot; QUESTION #${n.qNum}
                                        <a href="javascript:void(0)" onclick="switchExam('${n.examId}'); setTimeout(() => { document.getElementById('q-card-${n.postId}').scrollIntoView({behavior: 'smooth', block: 'center'}); }, 100);" 
                                           style="color: var(--accent); margin-left: 10px; text-decoration: none; font-size: 0.7rem; border: 1px solid var(--accent); padding: 2px 6px; border-radius: 4px;">VIEW LOCAL</a>
                                        <a href="javascript:void(0)" onclick="window.open('https://gateoverflow.in/${n.postId}/${slugify(n.exam)}-question-${n.qNum}', '_blank')" 
                                           style="color: var(--success); margin-left: 10px; text-decoration: none; font-size: 0.7rem; border: 1px solid var(--success); padding: 2px 6px; border-radius: 4px;">GO SOLUTION</a>
                                    </div>
                                    <div class="notes-summary-text">${n.text.replace(/\\n/g, '<br>')}</div>
                                </div>
                            `).join('')
                }
                    </div>
                </div>

                <h3 style="margin: 60px 0 30px; font-weight: 800; letter-spacing: -0.02em;">Subject-wise Breakdown</h3>
                <div id="subject-breakdown"></div>
            `;

            const breakdown = document.getElementById('subject-breakdown');
            Object.keys(subjectStats).sort().forEach(s => {
                const stats = subjectStats[s];
                const row = document.createElement('div');
                row.className = 'analytics-subject-row';
                row.innerHTML = `
                < div class="analytics-subject-info" >
                        <div class="analytics-subject-name">${s}</div>
                        <div class="analytics-subject-stats">
                            ${stats.complete} Complete &middot; ${stats.partial} Partial &middot; ${stats.starred} Starred &middot; ${stats.total} Total
                        </div>
                    </div >
                <div style="width: 150px">
                    <div class="progress-container" style="height: 6px">
                        <div class="progress-bar complete" style="width: ${(stats.complete / stats.total) * 100}%"></div>
                    </div>
                    <div class="progress-container" style="height: 6px; margin-top: 4px;">
                        <div class="progress-bar partial" style="width: ${(stats.partial / stats.total) * 100}%"></div>
                    </div>
                </div>
            `;
                breakdown.appendChild(row);
            });

            document.querySelector('.main-view').scrollTop = 0;
        }

        function toggleStar(postId) {
            let stars = JSON.parse(localStorage.getItem('gateStars') || '{}');

            if (stars[postId]) {
                delete stars[postId];
            } else {
                stars[postId] = true;
            }

            localStorage.setItem('gateStars', JSON.stringify(stars));

            // Update UI
            const btn = document.querySelector(`#q - card - ${postId} .star - btn`);
            if (btn) {
                btn.classList.toggle('active');
                btn.innerHTML = stars[postId]
                    ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/></svg>'
                    : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957-2.851-2.712 3.965-.563L8 3.483l1.721 3.424 3.965.563-2.85 2.712.693 3.957-3.685-1.894z"/></svg>';
            }

            updateFilterCounts();
            updateTagDropdown(); // Refresh dropdown counts

            if (currentFilter === 'starred') {
                renderQuestions();
            }
        }

        function showAddTag(postId) {
            const container = document.getElementById(`tags - container - ${postId} `);
            const btn = container.querySelector('.add-tag-btn');
            btn.style.display = 'none';

            const inputContainer = document.createElement('div');
            inputContainer.className = 'tag-input-container';
            inputContainer.innerHTML = `
                < input type = "text" class="tag-input" id = "tag-input-${postId}" placeholder = "New tag..." autocomplete = "off" >
                    <div class="tag-suggestions" id="tag-suggestions-${postId}"></div>
            `;
            container.appendChild(inputContainer);

            const input = document.getElementById(`tag - input - ${postId} `);
            input.focus();

            const suggestions = document.getElementById(`tag - suggestions - ${postId} `);
            const allTags = getAllUsedTags();

            const showSuggestions = (filter = '') => {
                const filtered = filter
                    ? allTags.filter(t => t.toLowerCase().includes(filter.toLowerCase()))
                    : allTags;

                if (filtered.length > 0) {
                    suggestions.innerHTML = filtered.map(t => `< div class="tag-suggestion-item" onclick = "addTag('${postId}', '${t}')" > ${t}</div > `).join('');
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            };

            // Show all tags initially if any exist
            showSuggestions();

            input.oninput = () => {
                showSuggestions(input.value);
            };

            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    addTag(postId, input.value);
                } else if (e.key === 'Escape') {
                    renderTags(postId);
                }
            };

            // Blur handling with delay to allow clicking suggestions
            input.onblur = () => {
                setTimeout(() => {
                    if (document.getElementById(`tag - input - ${postId} `)) {
                        renderTags(postId);
                    }
                }, 200);
            };
        }

        function getAllUsedTags() {
            const tagsData = JSON.parse(localStorage.getItem('gateTags') || '{}');
            const allTags = new Set();
            Object.values(tagsData).forEach(tags => {
                tags.forEach(t => allTags.add(t));
            });
            return Array.from(allTags).sort();
        }

        function updateTagDropdown() {
            const dropdown = document.getElementById('tag-filter-dropdown');
            if (!dropdown) return;

            // Find current exam data
            let examData = null;
            for (const s in portalData) {
                const found = portalData[s].find(e => e.id === activeExamId);
                if (found) {
                    examData = found;
                    break;
                }
            }
            if (!examData) return;

            const tagsData = JSON.parse(localStorage.getItem('gateTags') || '{}');
            const starsData = JSON.parse(localStorage.getItem('gateStars') || '{}');
            const tagCounts = {};
            let starredCount = 0;
            let sectionTotal = 0;
            const sectionsToShow = currentSectionFilter === 'all'
                ? examData.sections
                : examData.sections.filter(s => s.name === currentSectionFilter);

            sectionsToShow.forEach(section => {
                section.questions.forEach(q => {
                    const qid = q.post_id;
                    const qTags = tagsData[qid] || [];
                    qTags.forEach(t => {
                        tagCounts[t] = (tagCounts[t] || 0) + 1;
                    });
                    if (starsData[qid]) starredCount++;
                    sectionTotal++;
                });
            });
            const sortedTags = Object.keys(tagCounts).sort();

            const currentValue = dropdown.value;
            dropdown.innerHTML = `
                <option value="all"> All Tags (${sectionTotal})</option>
                    <option value="starred" ${currentValue === 'starred' ? 'selected' : ''}> Starred (${starredCount})</option>
                ${sortedTags.map(t => `<option value="${t}" ${t === currentValue ? 'selected' : ''}>${t} (${tagCounts[t]})</option>`).join('')}
            `;

            // If the previously selected tag is no longer available, reset to all
            if (currentValue !== 'all' && currentValue !== 'starred' && !tagCounts[currentValue]) {
                currentTagFilter = 'all';
                dropdown.value = 'all';
                renderQuestions();
            }
        }

        function addTag(postId, tag) {
            if (!tag || tag.trim() === '') return;
            tag = tag.trim();

            let tagsData = JSON.parse(localStorage.getItem('gateTags') || '{}');

            if (!tagsData[postId]) tagsData[postId] = [];
            if (!tagsData[postId].includes(tag)) {
                tagsData[postId].push(tag);
                localStorage.setItem('gateTags', JSON.stringify(tagsData));
                updateTagDropdown(); // Refresh dropdown
            }

            renderTags(postId);
        }

        function removeTag(postId, tag) {
            let tagsData = JSON.parse(localStorage.getItem('gateTags') || '{}');

            if (tagsData[postId]) {
                tagsData[postId] = tagsData[postId].filter(t => t !== tag);
                if (tagsData[postId].length === 0) delete tagsData[postId];
                localStorage.setItem('gateTags', JSON.stringify(tagsData));
                updateTagDropdown(); // Refresh dropdown
            }

            renderTags(postId);
        }

        function renderTags(postId) {
            const tagsData = JSON.parse(localStorage.getItem('gateTags') || '{}');
            const tags = tagsData[postId] || [];
            const container = document.getElementById(`tags - container - ${postId} `);

            container.innerHTML = `
                ${tags.map(t => `
                    <div class="tag-pill">
                        ${t}
                        <span class="tag-remove" onclick="removeTag('${postId}', '${t}')">&times;</span>
                    </div>
                `).join('')
                }
            <button class="add-tag-btn" onclick="showAddTag('${postId}')">+ Tag</button>
            `;
        }

        function toggleAns(postId) {
            const el = document.getElementById('ans-' + postId);
            const btn = document.getElementById('btn-ans-' + postId);
            if (el.style.display === 'none' || el.style.display === '') {
                el.style.display = 'block';
                btn.innerText = 'HIDE SOLUTION';
                btn.classList.add('active');
            } else {
                el.style.display = 'none';
                btn.innerText = 'REVEAL SOLUTION';
                btn.classList.remove('active');
            }
        }

        function toggleNotes(postId) {
            const el = document.getElementById('notes-area-' + postId);
            const btn = document.getElementById('btn-notes-' + postId);
            if (el.style.display === 'none' || el.style.display === '') {
                el.style.display = 'block';
                btn.style.background = 'var(--accent)';
                btn.style.color = '#020617';
            } else {
                el.style.display = 'none';
                btn.style.background = '#334155';
                btn.style.color = 'white';
            }
        }

        function saveNote(postId) {
            const text = document.getElementById('notes-text-' + postId).value;
            const statusEl = document.getElementById('save-status-' + postId);

            let notesData = JSON.parse(localStorage.getItem('gateNotes') || '{}');
            if (text.trim() === '') {
                delete notesData[postId];
            } else {
                notesData[postId] = text;
            }
            localStorage.setItem('gateNotes', JSON.stringify(notesData));

            // Show saved status
            statusEl.style.display = 'inline';
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 2000);
        }

        function setQuestionStatus(postId, status) {
            const card = document.getElementById('q-card-' + postId);

            // Update card classes
            card.classList.remove('status-none', 'status-partial', 'status-complete');
            card.classList.add('status-' + status);

            // Update button active states in the footer
            const footer = card.querySelector('.status-group');
            footer.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.toggle('active', btn.classList.contains(status));
            });

            // Update storage - now using post_id directly
            let masteryData = JSON.parse(localStorage.getItem('gateMastery') || '{}');

            // Migration check: if old array format exists, convert it
            if (Array.isArray(masteryData)) {
                masteryData = masteryData.reduce((acc, mid) => ({ ...acc, [mid]: 'complete' }), {});
            }

            if (status === 'none') {
                delete masteryData[postId];
            } else {
                masteryData[postId] = status;
            }

            localStorage.setItem('gateMastery', JSON.stringify(masteryData));

            // Update filter counts and sidebar progress
            updateFilterCounts();
            renderSidebar(document.getElementById('subject-search').value);

            // If a filter is active and the new status doesn't match, we might want to hide it.
            // But doing it immediately might be jarring. Let's do it with a small delay or just wait for next render.
            // For now, let's keep it visible until the user manually refreshes or changes filter,
            // OR we can just call renderQuestions() if we want it to be immediate.
            if (currentFilter !== 'all' && status !== currentFilter) {
                // fade out and remove
                card.style.opacity = '0.5';
                card.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    renderQuestions();
                }, 500);
            }
        }

        document.getElementById('subject-search').addEventListener('input', (e) => {
            renderSidebar(e.target.value);
        });

        // Track scroll position
        document.querySelector('.main-view').addEventListener('scroll', (e) => {
            if (activeExamId) {
                localStorage.setItem('gateScrollPos', e.target.scrollTop);
            }
        });

        // --- AI Feature ---
        async function askAI(postId) {
            const aiArea = document.getElementById(`ai - area - ${postId} `);
            const aiContent = document.getElementById(`ai - content - ${postId} `);
            const btn = document.getElementById(`btn - ai - ${postId} `);

            // Toggle if already visible
            if (aiArea.style.display === 'block') {
                aiArea.style.display = 'none';
                return;
            }

            // If content already exists in DOM, just show it
            if (aiContent.innerHTML.trim() !== '') {
                aiArea.style.display = 'block';
                return;
            }

            // Check Cache
            const cachedSolutions = JSON.parse(localStorage.getItem('gateAISolutions') || '{}');
            if (cachedSolutions[postId]) {
                aiArea.style.display = 'block';
                aiContent.innerHTML = cachedSolutions[postId];
                // Re-render MathJax for the cached content
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([aiContent]).catch((err) => console.log('MathJax error:', err));
                }
                return;
            }

            // Get API Key
            let apiKey = localStorage.getItem('gateGeminiKey');
            if (!apiKey) {
                apiKey = prompt("Please enter your Google Gemini API Key:");
                if (!apiKey) return;
                localStorage.setItem('gateGeminiKey', apiKey);
            }

            // Show loading
            aiArea.style.display = 'block';
            aiContent.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div> Generating solution...';

            // Construct Prompt
            const questionText = document.querySelector(`#q - card - ${postId} .q - body`).innerText;
            const propmt = `
You are an expert Computer Science tutor helping a student with GATE(Graduate Aptitude Test in Engineering) questions.
Please provide a detailed, step - by - step solution for the following question. 
Explain the concepts involved clearly.

                Question:
${questionText}

Format Requirements:
            1. Use HTML tags for structure(<h3>, <p>, <ul>, <li>, <strong>, etc.).
                2. Do NOT use markdown (e.g., no # headers or * bold).
                3. For mathematical equations, use LaTeX syntax enclosed in single dollar signs for inline math (e.g., $x^2$) and double dollar signs for display math (e.g., $$x^2$$).
                4. Do not include <html>, <head>, or <body> tags.
                    `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: propmt
                            }]
                        }]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const aiText = data.candidates[0].content.parts[0].text;
                let cleanHtml = aiText.replace(/```html/g, '').replace(/```/g, '');

                // Fallback: If no HTML tags are detected, convert newlines to <br> for readability
                if (!cleanHtml.includes('<p>') && !cleanHtml.includes('<div>') && !cleanHtml.includes('<ul>')) {
                    cleanHtml = cleanHtml.replace(/\n/g, '<br>');
                }

                aiContent.innerHTML = cleanHtml;

                // Cache the solution
                cachedSolutions[postId] = cleanHtml;
                localStorage.setItem('gateAISolutions', JSON.stringify(cachedSolutions));

                // Re-render MathJax for the new content
                if (window.MathJax && window.MathJax.typesetPromise) {
                    window.MathJax.typesetPromise([aiContent]).catch((err) => console.log('MathJax error:', err));
                }

            } catch (error) {
                console.error("AI Error:", error);
                aiContent.innerHTML = `<div style="color: #f87171;">Error generating solution: ${error.message}. <br> <span style="text-decoration: underline; cursor: pointer;" onclick="localStorage.removeItem('gateGeminiKey'); location.reload();">Reset API Key</span></div>`;
            }
        }

        function saveGeminiKey() {
            const input = document.getElementById('gemini-api-input');
            const key = input.value.trim();
            if (key) {
                localStorage.setItem('gateGeminiKey', key);
                alert('API Key saved successfully!');
            } else {
                localStorage.removeItem('gateGeminiKey');
                alert('API Key removed.');
            }
        }

        window.onload = initPortal;
    </script>
</body>

</html>